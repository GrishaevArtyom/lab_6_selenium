name: Run Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  run_tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      # Кэшируем chromedriver (wdm) и venv отдельно для надёжности
      - name: Cache chromedriver (WDM)
        uses: actions/cache@v4
        with:
          path: ~/.wdm
          key: ${{ runner.os }}-wdm-${{ hashFiles('requirements.txt') }}

      - name: Cache venv
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade -r requirements.txt
        if: steps.cache-venv.outputs.cache-hit != 'true'

      - name: Activate venv and verify versions
        run: |
          source .venv/bin/activate
          echo "✅ Chrome:"
          google-chrome --version
          echo "✅ webdriver-manager:"
          pip show webdriver-manager | grep -E "Version"
          echo "✅ Selenium:"
          pip show selenium | grep -E "Version"
          echo "✅ chromedriver from WDM:"
          python -c "
from webdriver_manager.chrome import ChromeDriverManager
path = ChromeDriverManager().install()
print('→', path)
import os
if os.path.isdir(path):
    print('⚠️ Path is a directory. Contents:')
    for f in os.listdir(path):
        print('  -', f)
else:
    print('✅ Path is a file.')
          "

      - name: Run tests
        run: |
          source .venv/bin/activate
          python -m pytest tests/ -v
        env:
          # Убедимся, что в CI нет проблем с дисплеем
          DISPLAY: ":99"